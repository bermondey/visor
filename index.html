import React, { useState, useEffect } from 'react';
import { Button } from "@/components/ui/button";
import { Upload } from 'lucide-react';

const MAPBOX_TOKEN = 'pk.eyJ1IjoiYmVybW9uZGV5IiwiYSI6ImNtMnZ4YzNuZzAwcDEycXM0bjUwdmc1OWkifQ.4mUWQlYMt_kH3GfVAptJBA';

const VisorRutasGPS = () => {
  const [rutas, setRutas] = useState([]);
  const [mapa, setMapa] = useState(null);

  // Inicializar el mapa
  useEffect(() => {
    // Cargar el script de Mapbox
    const loadMapbox = async () => {
      // Esperar a que se cargue el CSS
      const link = document.createElement('link');
      link.href = 'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css';
      link.rel = 'stylesheet';
      document.head.appendChild(link);

      // Esperar a que se cargue el JS
      const script = document.createElement('script');
      script.src = 'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js';
      script.async = true;
      document.body.appendChild(script);

      // Esperar a que el script se cargue
      await new Promise((resolve) => {
        script.onload = resolve;
      });

      // Inicializar el mapa
      if (window.mapboxgl) {
        window.mapboxgl.accessToken = MAPBOX_TOKEN;
        
        const mapaInstance = new window.mapboxgl.Map({
          container: 'mapa',
          style: 'mapbox://styles/mapbox/outdoors-v12',
          center: [2.5, 42.5], // Pirineos
          zoom: 9
        });

        // Añadir controles de navegación
        mapaInstance.addControl(new window.mapboxgl.NavigationControl());

        // Esperar a que el mapa se cargue
        mapaInstance.on('load', () => {
          setMapa(mapaInstance);
          console.log('Mapa cargado correctamente');
        });
      }
    };

    loadMapbox();
  }, []);

  const manejarSubidaArchivo = (evento) => {
    const archivo = evento.target.files[0];
    if (archivo && mapa) {
      const lector = new FileReader();
      lector.onload = (e) => {
        try {
          // Puntos de ejemplo (simular una ruta en los Pirineos)
          const puntos = [
            [0.7644, 42.6328],
            [0.7978, 42.6397],
            [0.8012, 42.6503]
          ];

          // Limpiar rutas anteriores
          const rutasExistentes = mapa.getStyle().layers
            .filter(layer => layer.id.startsWith('ruta-'))
            .map(layer => layer.id);
          
          rutasExistentes.forEach(rutaId => {
            mapa.removeLayer(rutaId);
            mapa.removeSource(rutaId);
          });

          // Añadir nueva ruta
          const rutaId = `ruta-${Date.now()}`;
          
          // Añadir la fuente de datos
          mapa.addSource(rutaId, {
            type: 'geojson',
            data: {
              type: 'Feature',
              properties: {},
              geometry: {
                type: 'LineString',
                coordinates: puntos
              }
            }
          });

          // Añadir la capa visual
          mapa.addLayer({
            id: rutaId,
            type: 'line',
            source: rutaId,
            layout: {
              'line-join': 'round',
              'line-cap': 'round'
            },
            paint: {
              'line-color': '#FF4500',
              'line-width': 4
            }
          });

          // Ajustar la vista a la ruta
          const bounds = new window.mapboxgl.LngLatBounds();
          puntos.forEach(point => bounds.extend(point));
          
          mapa.fitBounds(bounds, {
            padding: 50
          });

          // Añadir marcadores de inicio y fin
          new window.mapboxgl.Marker({ color: '#32CD32' })
            .setLngLat(puntos[0])
            .setPopup(new window.mapboxgl.Popup().setHTML('Inicio'))
            .addTo(mapa);

          new window.mapboxgl.Marker({ color: '#FF4500' })
            .setLngLat(puntos[puntos.length - 1])
            .setPopup(new window.mapboxgl.Popup().setHTML('Fin'))
            .addTo(mapa);

          // Actualizar la lista de rutas
          const nuevaRuta = {
            nombre: archivo.name,
            fecha: new Date().toLocaleDateString(),
            distanciaTotal: '10 km',
            elevacionPositiva: '500 m'
          };

          setRutas(rutasActuales => [...rutasActuales, nuevaRuta]);

        } catch (error) {
          console.error('Error al procesar la ruta:', error);
        }
      };
      lector.readAsText(archivo);
    }
  };

  return (
    <div className="h-screen p-4 bg-gray-50">
      <div className="h-full max-w-7xl mx-auto">
        <div className="h-full border rounded-lg bg-white shadow-sm">
          {/* Header */}
          <div className="p-4 border-b">
            <div className="flex items-center justify-between">
              <h1 className="text-xl font-semibold">Visor de Rutas GPS</h1>
              <label className="cursor-pointer">
                <input
                  type="file"
                  accept=".gpx,.kml"
                  onChange={manejarSubidaArchivo}
                  className="hidden"
                  id="upload-gpx"
                />
                <Button 
                  variant="default" 
                  className="bg-orange-500 hover:bg-orange-600 text-white font-bold flex items-center gap-2"
                  onClick={() => document.getElementById('upload-gpx').click()}
                >
                  <Upload size={16} />
                  Subir Ruta
                </Button>
              </label>
            </div>
          </div>

          {/* Contenido principal */}
          <div className="h-[calc(100%-4rem)] p-4">
            <div className="grid grid-cols-1 lg:grid-cols-4 gap-4 h-full">
              {/* Lista de rutas */}
              <div className="lg:col-span-1 border rounded-lg bg-white overflow-auto">
                <div className="p-4">
                  <h3 className="font-semibold mb-4">Tus Rutas</h3>
                  <div className="space-y-2">
                    {rutas.map((ruta, index) => (
                      <div
                        key={index}
                        className="p-2 rounded cursor-pointer hover:bg-gray-100"
                      >
                        <div className="font-medium">{ruta.nombre}</div>
                        <div className="text-sm text-gray-500">{ruta.fecha}</div>
                        <div className="text-sm">
                          Distancia: {ruta.distanciaTotal} • Desnivel: {ruta.elevacionPositiva}
                        </div>
                      </div>
                    ))}
                    {rutas.length === 0 && (
                      <div className="text-center text-gray-500 py-8">
                        <Upload className="mx-auto mb-2 opacity-50" size={24} />
                        <p>Sube una ruta para empezar</p>
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {/* Mapa */}
              <div className="lg:col-span-3">
                <div className="w-full h-[500px] border rounded-lg overflow-hidden relative">
                  <div id="mapa" className="absolute inset-0" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default VisorRutasGPS;
